# Скрипт для сбора метрик попыток входа через SSH `ssh_monitor.sh`

Этот скрипт представляет собой Bash-скрипт, который анализирует логи системы (`/var/log/auth.log`) и собирает метрики о успешных попытках входа через SSH. Метрики сохраняются в формате Prometheus и используются для мониторинга активности пользователей по количеству успешных входов gj SSH для данного пользователя и IP-адреса.

## Основные функции

1. **Анализ логов**:
   - Скрипт использует утилиту `awk` для парсинга файла `/var/log/auth.log`.
   - Выбираются только строки, содержащие успешные попытки входа (`sshd.*Accepted`).
2. **Генерация метрик**:
   - Для каждого уникального сочетания имени пользователя и IP-адреса подсчитывается количество успешных входов.
   - Метрики формируются в формате Prometheus с указанием имени пользователя (`username`) и IP-адреса (`ip`).
3. **Запись метрик**:
   - Метрики записываются в файл `/var/lib/node_exporter/ssh_login_metrics.prom`.
4. **Проверка ошибок**:
   - Скрипт проверяет наличие файла логов перед началом работы.
   - После записи метрик выполняется проверка на успех операции.

---

# Скрипт для сбора метрик использования дискового пространства Docker-контейнеров и образов `sum_container_sizes.sh`

Этот Bash-скрипт собирает информацию о размерах Docker-контейнеров и образов, преобразует их в метрики в формате Prometheus и записывает их в отдельные файлы.

## Основные функции

1. **Создание директории для метрик**:
   - Если директория `metrics` не существует, скрипт создает её.
2. **Очистка файлов метрик**:
   - Перед записью новых данных файлы очищаются, чтобы избежать дублирования старых метрик.
3. **Функция преобразования размеров**:
   - Функция `convert_to_bytes` преобразует размеры из формата `GB`, `MB`, `KB`, `B` в байты.
4. **Сбор информации о контейнерах**:
   - Используется команда `docker ps -s` для получения информации о размерах активных контейнеров.
   - Для каждого контейнера подсчитывается суммарный размер (файловая система + виртуальный размер) и преобразуется в мегабайты.
5. **Сбор информации об образах**:
   - Используется команда `docker images` для получения информации о размерах образов.
   - Пропускаются образы с пустыми значениями `Repository` или `Tag` (например, `<none>:<none>`).
6. **Запись метрик**:
   - Метрики записываются в двух файлах: `container_sizes.prom` и`image_sizes.prom`.

---

# Скрипт для переноса файлов с метриками в директорию Node Exporter `move_metrics.sh`

Скрипт выполняет следующие задачи:
- Проверяет наличие указанных файлов метрик в исходной директории (`pg_metrics.prom`, `container_sizes.prom`, `image_sizes.prom`, `gpu.prom`).
- Переносит найденные файлы в целевую директорию (`/var/lib/node_exporter`), если они существуют.
- Выводит сообщения о результатах операций: успешном переносе или отсутствии файла.

## Примечание

- Скрипты `sum_container_sizes.sh` и `pg_metrics_exporter.py` направляют вывод в директорию `/metrics`, а затем копируют его в `/var/lib/node_exporter/` с помощью скрипта `move_metrics.sh`.
- Возможно это не совсем правильно и нужно было сразу делать запись их /var/lib/node_exporter/, но было много разных вариантов реалиазации этих задач, в том числе с использованием разных экспортеров и этот вариант был рабочим, соответственно его пока и оставил, в следующий раз буду оптимизировать процессы. 

# Скрипт для сбора метрик использования GPU и процессов `gpu_test.sh`

В связи с постоянными трудностями по мониторингу нагрузки за GPU, решено было добавить мониторинг Bash-скриптом который собирает информацию о состоянии графических процессоров (GPU) с использованием утилиты `nvidia-smi` и записывает данные в формате Prometheus. Метрики включают использование GPU, потребление памяти, температуру и использование памяти отдельными процессами.

## Основные функции

1. **Очистка файла метрик**:
   - Перед записью новых данных файл очищается, чтобы избежать дублирования старых метрик.
2. **Функция безопасного извлечения значений**:
   - Функция `get_metric` используется для извлечения конкретных значений из строк вывода команды `nvidia-smi`.
3. **Сбор основных метрик GPU**:
   - Утилизация GPU (`gpu_utilization`): Процент загрузки GPU.
   - Использование памяти GPU (`gpu_memory_used`): Количество используемой памяти в MiB.
   - Общая память GPU (`gpu_memory_total`): Общий объем памяти GPU в MiB.
   - Температура GPU (`gpu_temperature`): Температура GPU в градусах Цельсия.
4. **Сбор информации о процессах**:
   - Для каждого процесса, использующего GPU, собираются:
     - PID (идентификатор процесса).
     - Имя процесса.
     - Потребление памяти процессом в MiB.
5. **Запись метрик**:
   - Метрики записываются в файл в формате Prometheus с соответствующими метками.
